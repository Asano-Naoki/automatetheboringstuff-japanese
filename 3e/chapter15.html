<html><head><meta http-equiv="content-type" content="text/html; charset=UTF-8"><link href="style.css" rel="stylesheet" type="text/css" /><title>Pythonで退屈な作業を自動化する
</title></head><body><div type="frontmatter" class="calibre" id="calibre_link-0">







<div type="bodymatter" class="calibre" id="calibre_link-402">
<section type="chapter" role="doc-chapter" aria-labelledby="ch15">
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-913" aria-label="359"></span>
<hgroup>
<h2 class="title" id="calibre_link-1861">
<span class="tpt"><span class="sans_dogma_ot_bold_b_">15</span></span> <span class="ct"><span class="sans_dogma_ot_bold_b_">Googleスプレッドシート</span></span>
</h2>
</hgroup>
<figure class="opener"><img class="opener1" src="images/000112.jpg" role="presentation" alt="" />
</figure>
<p class="introtni">Googleスプレッドシートは、GoogleアカウントかGmailアドレスを持っていたら誰でも無料で使える、ウェブベースのスプレッドシートアプリケーションです。機能が豊富で便利であり、Excelのライバルと言えます。Googleスプレッドシートには独自のAPIがありますが、このAPIはややこしくて使いにくいです。本章では、EZSheetsというサードパーティのライブラリを紹介します。このライブラリでは、一般的な操作が簡単にできるようにGoogleスプレッドシートAPIの細かい部分を処理してくれるので、自分でそのAPIの使い方を調べなくてもすみます。</p>
<section type="division" aria-labelledby="sec1">
<h3 class="h" id="calibre_link-1862"><span id="calibre_link-403"></span><span class="sans_futura_std_bold_b_">EZSheetsのインストールと設定</span></h3>
<p class="tni">EZSheetsは、<span>付録A</span>の指示に沿ってpipコマンドラインツールでインストールできます。</p>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-914" aria-label="360"></span>PythonスクリプトからEZSheetsでGoogleスプレッドシートにアクセスして編集するには、事前に認証情報JSONファイルと2つのトークンJSONファイルを用意する必要があります。認証情報を作成するには以下の5つの手順を進めます。</p>
<p class="listnumberf">  1. 新しいGoogle Cloudプロジェクトを作成する</p>
<p class="listnumber">  2. プロジェクトでGoogle Sheets APIとGoogle Drive APIを有効化する</p>
<p class="listnumber">  3. OAuth同意画面を設定する</p>
<p class="listnumber">  4. 認証情報を作成する</p>
<p class="listnumberl">  5. 認証情報ファイルでログインする</p>
<p class="tx">これは大変そうに見えるかもしれませんが、一度このセットアップをすると、あとは自由に使えます。Google/Gmailのアカウントが必要になります。Pythonスクリプトのバグがお持ちのスプレッドシートに悪影響を及ぼさないように、既存のアカウントを使うのではなく、新しいGoogleアカウントを作成することを強くおすすめします。本章を通して、<i class="calibre5">「自分のGoogleアカウント」</i>や<i class="calibre5">「自分のGmailアドレス」</i>で、Pythonスクリプトによりアクセスするスプレッドシートを所有しているGoogleアカウントを指します。</p>
<p class="tx">GoogleはGoogle Cloudコンソールのレイアウトや言い回しを変更する可能性がありますが、ここで説明する基本的な手順は変わらないはずです。（訳注：以下の説明では、訳出時の日本語版の画面に従って原文を訳し変えています。）</p>
<section type="division" aria-labelledby="sec2">
<h4 class="h1" id="calibre_link-1863"><span id="calibre_link-404"></span><span class="sans_futura_std_heavy_oblique_bi_">新しいGoogle Cloudプロジェクトを作成する</span></h4>
<p class="tni">まず、Google Cloudプロジェクトを作成する必要があります。ブラウザで<i class="calibre5"><a href="https://console.cloud.google.com" class="calibre1">https://<wbr></wbr>console<wbr></wbr>.cloud<wbr></wbr>.google<wbr></wbr>.com</a></i>に移動し、ユーザ名とパスワードを入力して自分のGoogleアカウントにサインインしてください。ようこそページに移動するはずです。そのページの画面上部の<b class="calibre10">「プロジェクトの選択」</b>をクリックしてください。ポップアップウィンドウが表示されますから、<b class="calibre10">「新しいプロジェクト」</b>をクリックします。新しいプロジェクトのページに移動するはずです。</p>
<p class="tx">Google Cloudでは、“My Project 23135”のようなプロジェクト名と“macro-nuance-362516”のようなプロジェクトIDが作成されます。これらの名前はPythonスクリプトを使うときに見えませんが、プロジェクト名は好きなように変更できます（プロジェクトIDは変更できません）。私はウェブサイトが作成したデフォルトの名前をそのまま使います。場所は「組織なし」のままで構いません。無料のGoogleアカウントが作成できるプロジェクトは12個までですが、本書のすべてのPythonスクリプトに1つのプロジェクトで対応できます。青色の<b class="calibre10">「作成」</b>ボタンをクリックしてプロジェクトを作成してください。</p>
</section>
<section type="division" aria-labelledby="sec3">
<h4 class="h1" id="calibre_link-1864"><span id="calibre_link-405"></span><span class="sans_futura_std_heavy_oblique_bi_">Google Sheets APIとGoogle Drive APIを有効化する</span></h4>
<p class="tni"><i class="calibre5"><a href="https://console.cloud.google.com" class="calibre1">https://<wbr></wbr>console<wbr></wbr>.cloud<wbr></wbr>.google<wbr></wbr>.com</a></i>で、左上のナビゲーションメニューボタンをクリックします（水平の三本線のアイコンで、しばしば<i class="calibre5">ハンバーガー</i>アイコンと呼ばれるものです）。 <b class="calibre10">APIとサービス</b> <span class="listbullet_menuarrow"></span> <b class="calibre10">ライブラリ</b>と進み、APIのライブラリページに移動します。Gmail、Google Maps、Google Cloud Storage、その他のGoogleのサービスのGoogle APIが多数表示されます。このプロジェクトでGoogle Sheets APIとGoogle Drive APIを使えるようにする必要があります。EZSheetsはスプレッドシートファイルのアップロードとダウンロードにGoogle Drive APIを使います。</p>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1075" aria-label="361"></span>下にスクロールしてGoogle Sheets APIを探してクリックするか、検索バーにGoogle Sheets APIと入力して見つけます。Google Sheets APIのページに移動するので、青色の<b class="calibre10">「有効にする」</b>ボタンをクリックしてGoogle CloudプロジェクトでGoogle Sheets APIを使えるようにします。<b class="calibre10">APIとサービス</b><span class="listbullet_menuarrow"></span><b class="calibre10">API / サービスの詳細</b>ページにリダイレクトされ、そこでこのAPIの使用頻度の情報を確かめられます。Google Drive APIについても同じ手順で有効にしてください。</p>
<p class="tx">次に、このプロジェクトのOAuth同意画面を設定します。</p>
</section>
<section type="division" aria-labelledby="sec4">
<h4 class="h1" id="calibre_link-1865"><span id="calibre_link-406"></span><span class="sans_futura_std_heavy_oblique_bi_">OAuth同意画面を設定する</span></h4>
<p class="tni"><span class="thesansmonocd_w5regular_">import ezsheets</span>の初回実行時にOAuth同意画面が表示されます。左上のナビゲーションメニューボタンから<b class="calibre10">「OAuth同意画」</b>をクリックして、青色の<b class="calibre10">「開始」</b>ボタンを押してください。OAuth同意画面の第一段階のアプリ情報では、アプリ名（私は“Python Google API Script”のような一般的な名前にしています）と、ユーザーサポートメールにメールアドレスを入力し、<b class="calibre10">「次へ」</b>ボタンを押します。

第二段階の対象では、外部を選んで<b class="calibre10">「次へ」</b>ボタンを押します。

第三段階の連絡先情報では、自分のメールアドレスを入力して、<b class="calibre10">「次へ」</b>ボタンを押します。

第四段階の終了では、Google API サービス: ユーザーデータに関するポリシーに同意しますというチェックボックスにチェックを入れて、<b class="calibre10">「続行」</b>ボタンを押します。

最後に青色の<b class="calibre10">「作成」</b>ボタンをクリックします。</p>
<p class="tx"> 次に、このプロジェクトのスコープ、すなわちプロジェクトがどのリソースを使えるかの権限を定義します。左サイドバーの<b class="calibre10">「データアクセス」</b>をクリックして、<b class="calibre10">「スコープを追加または削除」</b>ボタンを押します。新しいパネルが表示されるので、<i class="calibre5">.../auth/drive</i> (the Google Drive API)と<i class="calibre5">.../auth/spreadsheets</i> (the Google Sheets API)のチェックボックスにチェックを入れます。それから青色の<b class="calibre10">「更新」</b>ボタンをクリックして、<b class="calibre10">「Save」</b>ボタンをクリックします。</p>
<p class="tx">最後に、対象ページで、Pythonのスクリプトから操作するスプレッドシートを所有しているGoogleアカウントのGmailアドレスを追加します。Googleのアプリ承認プロセスを通過しなければ、スクリプトが操作できるのはここでメールアドレスを追加したものに限られます。左サイドバーの対象をクリックして、<b class="calibre10">「Add users」</b>ボタンを押します。新しく表示されるパネルで自分のGoogleアカウントのGmailアドレスを入力し、青色の<b class="calibre10">「保存」</b>ボタンをクリックします。</p>
<p class="tx"> </p>
</section>
<section type="division" aria-labelledby="sec5">
<h4 class="h1" id="calibre_link-1866"><span id="calibre_link-407"></span><span class="sans_futura_std_heavy_oblique_bi_">認証情報を作成する</span></h4>
<p class="tni">認証情報ファイルを作成する必要があります。EZSheetsがGoogleのAPIを利用するにはこの認証情報ファイルが必要です。誰でも見られる公開状態で共有されているスプレッドシートであってもそうです。左上のナビゲーションメニューボタンから<b class="calibre10">APIとサービス</b>、<b class="calibre10">認証情報</b>とたどると、認証情報のページに移動します。画面上部の<b class="calibre10">「認証情報を作成」</b>リンクをクリックします。APIキー、OAuthクライアントID、サービスアカウントのうちどの種類の認証情報を作成するかを尋ねるサブメニューが表示されるので、<b class="calibre10">OAuthクライアントID</b>をクリックします。 </p>
<p class="tx">次のページでは、アプリケーションの種類で<b class="calibre10">デスクトップアプリ</b>を選び、名前はデフォルトのデスクトップ クライアント: 1のままにします。お望みなら別の名前に変更できます。この名前はPythonスクリプトで表示されません。青色の<b class="calibre10">「作成」</b>ボタンをクリックします。</p>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1076" aria-label="362"></span>ポップアップウィンドウが表示されます。<b class="calibre10">JSONをダウンロード</b>をクリックして認証情報ファイルをダウンロードします。<i class="calibre5">client_secret_282792235794-p2o9gfcub4htibfg2u207gcomco9nqm7.apps.googleusercontent.com.json</i>のような名前のファイルです。このファイルをPythonスクリプトと同じフォルダ内に置きます。<i class="calibre5">credentials-sheets.json</i>といったシンプルな名前に変更してもよいです。EZSheetsは、<i class="calibre5">credentials-sheets.json</i>という名前のファイルか、<i class="calibre5">client_secret_*.json</i>という形の名前のファイルを探します。</p>
</section>
<section type="division" aria-labelledby="sec6">
<h4 class="h1" id="calibre_link-1867"><span id="calibre_link-408"></span><span class="sans_futura_std_heavy_oblique_bi_">認証情報ファイルでログインする</span></h4>
<p class="tni">認証情報JSONファイルと同じフォルダでPythonの対話型シェルを実行し、<span class="sans_thesansmonocd_w7bold_b_">import ezsheets</span>を実行してください。EZSheetsは自動的に<span class="thesansmonocd_w5regular_">ezsheets.init()</span> 関数を呼び出し、現在の作業フォルダを確認して、認証情報JSONファイルを探します。ファイルが見つかれば、EZSheetsはウェブブラウザを立ち上げてOAuth同意画面を表示し、トークンファイルを作成します。EZSheetsは、スプレッドシートにアクセスするのに、認証情報JSONファイルに加えて、<i class="calibre5">token-drive.pickle</i>と<i class="calibre5">token-sheets.pickle</i>という名前のこれらのトークンファイルも必要とします。トークンファイルの作成は一度だけで、次に<span class="thesansmonocd_w5regular_">import ezsheets</span>を実行したときには新しくトークンファイルが作成されることはありません。</p>
<p class="tx">（ブラウザでOAuth同意画面が表示されたら）自分のGoogleアカウントでサインインします。Google CloudプロジェクトのOAuth同意画面でテストユーザーに追加したのと同じメールアドレスでサインインしてください。「このアプリは Googleで確認されていません」という警告メッセージが表示されますが、自分が作成したアプリですから、気にしないでください。<b class="calibre10">「続行」</b>をクリックします。「Python Google API Script が Google アカウントへのアクセスを求めています」のように書かれている別のページに移動するはずですから（OAuth同意画面で入力したアプリ名が表示されます）、<b class="calibre10">「続行」</b>をクリックします。「The authentication flow has completed. You may close this window.」とだけ書かれたページが表示されます。もうブラウザウィンドウを閉じても構いません。</p>
<p class="tx">Sheets APIの認証フローが完了したら、次に開くウィンドウでDrive APIの同じ認証フローを繰り返します。2回目のウィンドウを閉じると、<i class="calibre5">token-drive.pickle</i>と<i class="calibre5">token-sheets.pickle</i>ファイルが同じフォルダにあるはずです。これらのファイルはパスワードと同じように扱い、共有しないでください。これらのファイルを使ってログインしてGoogleスプレッドシートにアクセスできてしまいます。</p>
</section>
<section type="division" aria-labelledby="sec7">
<h4 class="h1" id="calibre_link-1868"><span id="calibre_link-409"></span><span class="sans_futura_std_heavy_oblique_bi_">認証情報ファイルを失効させる</span></h4>
<p class="tni">認証情報ファイルまたはトークンファイルを共有してしまったら、そのファイルを入手した人が、Googleアカウント本体のパスワードの変更はできないとしても、スプレッドシートにアクセスできてしまいます。<i class="calibre5"><a href="https://console.developers.google.com" class="calibre1">https://<wbr></wbr>console<wbr></wbr>.developers<wbr></wbr>.google<wbr></wbr>.com</a></i>にログインすればそのファイルを失効させられます。サイドバーの<b class="calibre10">認証情報</b>のリンクをクリックします。OAuth 2.0 クライアント IDの表の中にある、共有した認証情報ファイルの横のゴミ箱のアイコンをクリックします。一度失効させると、その認証情報ファイルとトークンファイルは使えなくなります。新しい認証JSONファイルとトークンファイルをもう一度作成します。</p>
</section>
</section>
<section type="division" aria-labelledby="sec8">
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-1001" aria-label="363"></span>
<h3 class="h" id="calibre_link-1869"><span id="calibre_link-410"></span><span class="sans_futura_std_bold_b_">スプレッドシートオブジェクト</span></h3>
<p class="tni">Googleスプレッドシートでは、<i class="calibre5">スプレッドシート</i>は複数の<i class="calibre5">シート</i>（<i class="calibre5">ワークシート</i>）を含み、それぞれのシートにはセルの行と列があります。セルには数値、日付、テキストなどのデータを入れます。セルには、フォント、幅、高さ、背景色などのプロパティもあります。図15-1は、<i class="calibre5">Books</i>と<i class="calibre5">Websites</i>の2つのシートがある<i class="calibre5">Sweigart Books</i>という名前のスプレッドシートを示しています。<i class="calibre5"><a href="https://autbor.com/examplegs" class="calibre1">https://<wbr></wbr>autbor<wbr></wbr>.com<wbr></wbr>/examplegs</a></i>でこのスプレッドシートをブラウザで閲覧できます。各シートの最初の列は<i class="calibre5">A</i>で最初の行は<i class="calibre5">1</i>です（インデックスが0から始まるPythonのリストとは異なります）。</p>
<figure class="img"><img class="img1" id="calibre_link-771" src="images/000028.jpg" alt="A Google Sheets spreadsheet with two tabs, Books and Websites. The Books tab is highlighted, showing a spreadsheet containing the columns TITLE, AUTHOR, YEAR PUBLISHED, and URL. The rows each contain information describing a book." />
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">図 15-1：</span><span class="sans_futura_std_book_">Books</span><span class="sans_futura_std_book_oblique_i_">と</span><span class="sans_futura_std_book_">Websites</span><span class="sans_futura_std_book_oblique_i_">の2つのシートがある</span><span class="sans_futura_std_book_">Sweigart Books</span>という名前のスプレッドシート</p></figcaption>
</figure>
<p class="tx">大部分の作業は<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトを変更することになるでしょうが、次の節で見るように<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトを変更することもできます。</p>
<section type="division" aria-labelledby="sec9">
<h4 class="h1" id="calibre_link-1870"><span id="calibre_link-411"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートの作成、更新、一覧表示</span></h4>
<p class="tni">既存のGoogleスプレッドシートからでも、新しい空白のスプレッドシートからでも、アップロードしたExcelファイルからでも、新しい<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトを作成できます。すべてのGoogleスプレッドシートには固有のIDがあり、URL中の<i class="calibre5">spreadsheets/d/</i>の後で<i class="calibre5">/edit</i>の前の部分に含まれています。例えば、<i class="calibre5"><a href="https://docs.google.com/spreadsheets/d/1TzOJxhNKr15tzdZxTqtQ3EmDP6em_elnbtmZIcyu8vI/edit#gid=0/" class="calibre1">https://<wbr></wbr>docs<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/spreadsheets<wbr></wbr>/d<wbr></wbr>/1TzOJxhNKr15tzdZxTqtQ3EmDP6em<wbr></wbr>_elnbtmZIcyu8vI<wbr></wbr>/edit#gid<wbr></wbr>=0<wbr></wbr>/</a></i>というURLなら、IDは<i class="calibre5">1TzOJxhNKr15tzdZxTqtQ3EmDP6em_elnbtmZIcyu8vI</i>です。</p>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1148" aria-label="364"></span>Googleスプレッドシートは<span class="thesansmonocd_w5regular_">ezsheets.Spreadsheet</span>オブジェクトで表されます。<span class="thesansmonocd_w5regular_">id</span>、<span class="thesansmonocd_w5regular_">url</span>、<span class="thesansmonocd_w5regular_">title</span>の属性があります。<span class="thesansmonocd_w5regular_">Spreadsheet()</span>関数で新しい空白のスプレッドシートを作成できます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">ss.title = 'Title of My New Spreadsheet'</b>
&gt;&gt;&gt; <b class="calibre10">ss.title</b>
'Title of My New Spreadsheet'
&gt;&gt;&gt; <b class="calibre10">ss.url</b>
'https://docs.google.com/spreadsheets/d/1gxz-Qr2-RNtqi_d7wWlsDlbtPLRQigcEXvCtdVwmH40/'
&gt;&gt;&gt; <b class="calibre10">ss.id</b>
'1gxz-Qr2-RNtqi_d7wWlsDlbtPLRQigcEXvCtdVwmH40'
</code></pre>
<p class="tx">IDまたはURL（スプレッドシートのURLにリダイレクトするURLも可）を渡すことで、既存のスプレッドシートをロードすることもできます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss1 = ezsheets.Spreadsheet('https://autbor.com/examplegs')</b>
&gt;&gt;&gt; <b class="calibre10">ss2 = ezsheets.Spreadsheet('https://docs.google.com/spreadsheets/d/1TzOJxh</b>
<b class="calibre10">NKr15tzdZxTqtQ3EmDP6em_elnbtmZIcyu8vI/')</b>
&gt;&gt;&gt; <b class="calibre10">ss3 = ezsheets.Spreadsheet('1TzOJxhNKr15tzdZxTqtQ3EmDP6em_elnbtmZIcyu8vI')</b>
&gt;&gt;&gt; <b class="calibre10">ss1 == ss2 == ss3</b>  # これらは同じスプレッドシート
True
</code></pre>
<p class="tx">既存のExcel、OpenOffice、CSV、TSVファイルをスプレッドシートにアップロードするには、ファイル名を<span class="thesansmonocd_w5regular_">ezsheets.upload()</span>に渡します。対話型シェルに以下の内容を入力してください。<i class="calibre5">my_spreadsheet.xlsx</i>の部分はご自身のExcelファイルに置き換えてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.upload('</b><b class="calibre10"><var class="calibre20">my_spreadsheet.xlsx</var></b><b class="calibre10">')</b>
&gt;&gt;&gt; <b class="calibre10">ss.title</b>
'<var class="calibre20">my_spreadsheet</var>'
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">listSpreadsheets()</span>関数を呼び出せば、自分のGoogleアカウントのスプレッドシートを一覧表示できます。この関数は、キーがスプレッドシートID、値がスプレッドシート名の辞書を返します。<i class="calibre5">ゴミ箱</i>フォルダにある削除されたスプレッドシートも含まれます。スプレッドシートをアップロードしてから、対話型シェルで以下の内容を実行してください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ezsheets.listSpreadsheets()</b>
{'<var class="calibre20">1J-Jx6Ne2K_vqI9J2SO-TAXOFbxx_9tUjwnkPC22LjeU</var>': 'Education Data'}
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトを取得できたら、その属性やメソッドを通じて、Googleがホストしているオンラインのスプレッドシートを操作できます。</p>
</section>
<section type="division" aria-labelledby="sec10">
<h4 class="h1" id="calibre_link-1871"><span id="calibre_link-412"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートの属性にアクセスする</span></h4>
<p class="tni">実際のデータはスプレッドシートの各シートに存在しますが、<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトにはスプレッドシート自体を操作できる、<span class="thesansmonocd_w5regular_">title</span>、<span class="thesansmonocd_w5regular_">id</span>、<span class="thesansmonocd_w5regular_">url</span>、<span class="thesansmonocd_w5regular_">sheetTitles</span>、<span class="thesansmonocd_w5regular_">sheets</span>という属性があります。<i class="calibre5"><a href="https://autbor.com/examplegs" class="calibre1">https://<wbr></wbr>autbor<wbr></wbr>.com<wbr></wbr>/examplegs</a></i>のスプレッドシートで確かめてみましょう。このスプレッドシートを閲覧する権限はあっても編集する権限はありませんが、自分のアカウントのスプレッドシートにコピーして新しいスプレッドシートを作成することはできます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">example_ss = ezsheets.Spreadsheet('https://autbor.com/examplegs')</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">example_ss.sheets[0].copyTo(ss)</b>
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0].delete()</b>  # Sheet1シートを削除
&gt;&gt;&gt; <b class="calibre10">ss.url</b>
'https://docs.google.com/spreadsheets/d/15gjrbgTmUzItRt9KUcL4JajLaQU70xanstB1dXKoSlM/'
</code></pre>
<p class="tx">新しくコピーされたシートは、<i class="calibre5">Books</i>という元のシート名から、<i class="calibre5">Copy of Books</i>というシート名になります。対話型シェルで以下のコードを続けて実行してください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.title</b>  # スプレッドシート名
'Untitled spreadsheet'
&gt;&gt;&gt; <b class="calibre10">ss.title = 'Sweigart Books'</b>  # スプレッドシート名の変更
&gt;&gt;&gt; <b class="calibre10">ss.id</b>  # 一意のID（読み取り専用属性）
'15gjrbgTmUzItRt9KUcL4JajLaQU70xanstB1dXKoSlM'
&gt;&gt;&gt; <b class="calibre10">ss.url</b>  # 元URL（読み取り専用属性）
'https://docs.google.com/spreadsheets/d/15gjrbgTmUzItRt9KUcL4JajLaQU70xanstB1dXKoSlM/'
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>  # すべてのシート名
('Copy of Books',)
&gt;&gt;&gt; <b class="calibre10">ss.sheets</b>  # このスプレッドシートのSheetオブジェクト（順序あり）
(&lt;Sheet sheetId=1464919459, title='Copy of Books', rowCount=1000, columnCount=26&gt;,)
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0]</b>  # このスプレッドシートの最初のSheetオブジェクト
&lt;Sheet sheetId=1464919459, title='Copy of Books', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss['Copy of Books']</b>  # シート名でもアクセス可能
&lt;Sheet sheetId=1464919459, title='Copy of Books', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss.Sheet('New blank sheet')</b>  # 新しいシートの作成
&lt;Sheet sheetId=1759616008, title='New blank sheet', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss.sheets[1].delete()</b>  # このスプレッドシートの2番目のシートを削除
</code></pre>
<p class="tx">誰かがブラウザでスプレッドシートを変更した場合、<span class="thesansmonocd_w5regular_">refresh()</span>メソッドを呼び出すと、オンラインのデータに合うように、<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトをスクリプトから更新できます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.refresh()</b></code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトの属性だけでなく、<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのデータも更新されます。<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトに適用した変更はリアルタイムでオンラインのスプレッドシートに反映されます。</p>
</section>
<section type="division" aria-labelledby="sec11">
<h4 class="h1" id="calibre_link-1872"><span id="calibre_link-413"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートのダウンロードとアップロード</span></h4>
<p class="tni">Googleスプレッドシートは、Excel、OpenOffice、CSV、TSV、PDFと様々な形式でダウンロードできます。スプレッドシートのデータのHTMLを含むZIPファイルとしてダウンロードすることもできます。EZSheetsはこれらの形式でのダウンロードに対応する関数があります。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet('https://autbor.com/examplegs')</b>
&gt;&gt;&gt; <b class="calibre10">ss.title</b>
'Sweigart Books (DO NOT DELETE)'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsExcel()</b>  # スプレッドシートをExcelファイルとしてダウンロード
'Sweigart_Books.xlsx'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsODS()</b>  # スプレッドシートをOpenOfficelファイルとしてダウンロード
'Sweigart_Books.ods'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsCSV()</b>  # スプレッドシートをCSVファイルとしてダウンロード
'Sweigart_Books.csv'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsTSV()</b>  # スプレッドシートをTSVファイルとしてダウンロード
'Sweigart_Books.tsv'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsPDF()</b>  # スプレッドシートをPDFファイルとしてダウンロード
'Sweigart_Books.pdf'
&gt;&gt;&gt; <b class="calibre10">ss.downloadAsHTML()</b>  # スプレッドシートをHTMLを含むZIPファイルとしてダウンロード
'Sweigart_Books.zip'
</code></pre>
<p class="tx">CSVとTSV形式のファイルには一つのシートしか含まれません。よって、このどちらかの形式でGoogleスプレッドシートをダウンロードする場合は、最初のシートしか取得できません。別のシートをダウンロードするには、ダウンロードする前に<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトの順番を変える必要があります。</p>
<p class="tx">ダウンロード関数はすべてダウンロードしたファイル名の文字列を返します。ダウンロード関数に新しいファイル名を渡してファイル名を指定することもできます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.downloadAsExcel('</b><var class="calibre20">a_different_filename</var>.xlsx<b class="calibre10">')</b>
'<var class="calibre20">a_different_filename</var>.xlsx'
</code></pre>
<p class="tx">この関数はローカルに保存されたファイル名を返します。</p>
</section>
<section type="division" aria-labelledby="sec12">
<h4 class="h1" id="calibre_link-1873"><span id="calibre_link-414"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートの削除</span></h4>
<p class="tni">スプレッドシートを削除するには、<span class="thesansmonocd_w5regular_">delete()</span>メソッドを呼び出します。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>  # スプレッドシートの作成
&gt;&gt;&gt; <b class="calibre10">ezsheets.listSpreadsheets()</b>  # スプレッドシートの作成確認
{'1aCw2NNJSZblDbhygVv77kPsL3djmgV5zJZllSOZ_mRk': 'Delete me'}
&gt;&gt;&gt; <b class="calibre10">ss.delete()</b>  # スプレッドシートの削除
&gt;&gt;&gt; <b class="calibre10">ezsheets.listSpreadsheets()</b>  # ゴミ箱フォルダにあるスプレッドシートも一覧表示される
{'1aCw2NNJSZblDbhygVv77kPsL3djmgV5zJZllSOZ_mRk': 'Delete me'}
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">delete()</span>メソッドは、スプレッドシートをGoogleドライブの<i class="calibre5">ゴミ箱</i>フォルダに移動させます。 <i class="calibre5"><a href="https://drive.google.com/drive/trash" class="calibre1">https://<wbr></wbr>drive<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/drive<wbr></wbr>/trash</a></i>で自分の<i class="calibre5">ゴミ箱</i>フォルダの中身を見ることができます。<i class="calibre5">ゴミ箱</i>フォルダ内のスプレッドシートも<span class="thesansmonocd_w5regular_">listSpreadsheets()</span>が返す辞書に含まれます。スプレッドシートを完全に削除するには、<span class="thesansmonocd_w5regular_">permanent</span>キーワード引数に<span class="thesansmonocd_w5regular_">True</span>を渡します。</p>
<pre class="pre"><code class="calibre9"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1149" aria-label="367"></span>&gt;&gt;&gt; <b class="calibre10">ss.delete(permanent=True)</b>
&gt;&gt;&gt; <b class="calibre10">ezsheets.listSpreadsheets()</b>
{}
</code></pre>
<p class="tx">一般的に、自動化スクリプトでスプレッドシートを完全に削除するのはいい考えではありません。スクリプトにバグがあってもスプレッドシートを回復する術がないからです。無料のGoogleアカウントでもドライブはギガバイト単位の容量が利用できますから、容量を心配する必要はあまりないでしょう。</p>
</section>
</section>
<section type="division" aria-labelledby="sec13">
<h3 class="h" id="calibre_link-1874"><span id="calibre_link-415"></span><span class="sans_futura_std_bold_b_">シートオブジェクト</span></h3>
<p class="tni"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトは<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトを持っています。<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトは各シートの行と列のデータを表します。角かっこと整数のインデックスでシートにアクセスできます。</p>
<p class="tx"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトの<span class="thesansmonocd_w5regular_">sheets</span>属性は、スプレッドシートで表示される順番で<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのタプルを保持しています。対話型シェルに以下の内容を入力して、スプレッドシートの<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトにアクセスしてみてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>  # Sheet1という名前のシートが最初からある
&gt;&gt;&gt; <b class="calibre10">sheet2 = ss.Sheet('Spam')</b>
&gt;&gt;&gt; <b class="calibre10">sheet3 = ss.Sheet('Eggs')</b>
&gt;&gt;&gt; <b class="calibre10">ss.sheets</b>  # このスプレッドシートのSheetオブジェクト（順序あり）
(&lt;Sheet sheetId=0, title='Sheet1', rowCount=1000, columnCount=26&gt;, &lt;Sheet sheetId=284204004,
title='Spam', rowCount=1000, columnCount=26&gt;, &lt;Sheet sheetId=1920032872, title='Eggs',
rowCount=1000, columnCount=26&gt;)
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0]</b>  # このスプレッドシートの最初のSheetオブジェクト
&lt;Sheet sheetId=0, title='Sheet1', rowCount=1000, columnCount=26&gt;
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトの<span class="thesansmonocd_w5regular_">sheetTitles</span>属性はすべてのシート名を保持しています。対話型シェルで次のように入力してみてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>  # このスプレッドシートのすべてのシート名
('Sheet1', 'Spam', 'Eggs')
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトを取得できたら、次の節で説明するように、<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのメソッドでデータの読み書きができます。</p>
<section type="division" aria-labelledby="sec14">
<h4 class="h1" id="calibre_link-1875"><span id="calibre_link-416"></span><span class="sans_futura_std_heavy_oblique_bi_">データの読み書き</span></h4>
<p class="tni">Excelと同じように、Googleスプレッドシートのワークシートには、データを含むセルの行と列があります。角かっこ演算子<span class="thesansmonocd_w5regular_">[]</span> でセルの読み書きができます。例えば、対話型シェルに以下の内容を入力すると、新しいスプレッドシートを作成してデータを追加します。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">ss.title = 'My Spreadsheet'</b>
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-1056" aria-label="368"></span>&gt;&gt;&gt; <b class="calibre10">sheet = ss.sheets[0]</b>  # このスプレッドシートの最初のシートを取得
&gt;&gt;&gt; <b class="calibre10">sheet.title</b>
'Sheet1'
&gt;&gt;&gt; <b class="calibre10">sheet['A1'] = 'Name'</b>  # A1セルの値を設定
&gt;&gt;&gt; <b class="calibre10">sheet['B1'] = 'Age'</b>
&gt;&gt;&gt; <b class="calibre10">sheet['C1'] = 'Favorite Movie'</b>
&gt;&gt;&gt; <b class="calibre10">sheet['A1']</b>  # A1セルの値を読み取り
'Name'
&gt;&gt;&gt; <b class="calibre10">sheet['A2']</b>  # 空白セルは空文字列を返す
''
&gt;&gt;&gt; <b class="calibre10">sheet[2, 1]</b>  # 2列目1行目はB1と同じ
'Age'
&gt;&gt;&gt; <b class="calibre10">sheet['A2'] = 'Alice'</b>
&gt;&gt;&gt; <b class="calibre10">sheet['B2'] = 30</b>
&gt;&gt;&gt; <b class="calibre10">sheet['C2'] = 'RoboCop'</b>
&gt;&gt;&gt; <b class="calibre10">sheet['B2']</b>  # データはすべて文字列として返される
'30'
</code></pre>
<p class="tx">これらの指示によりGoogleスプレッドシートは図15-2のようになります。</p>
<figure class="img"><img class="img2" id="calibre_link-772" src="images/000029.jpg" alt="A Google Sheets spreadsheet containing “Name” in cell AI, “Age” in cell A2”, “Favorite Movie” in cell C2, “Alice” in cell A2, “30” in age B2, and “RoboCop” in cell C2." />
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">図 15-2：上記の例の指示により作成されたスプレッドシート</span></p></figcaption>
</figure>
<p class="tx"><span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのすべてのデータは<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトが最初にロードされたときにロードされます。そのため、データの読み取りは一瞬でできます。しかし、値をオンラインのスプレッドシートに書き込むには、ネットワーク接続が必要で、1秒程度かかります。数千セルを一つずつ更新すると非常に時間がかかります。一つずつ更新するのではなく、行全体や列全体を一度に更新する方法を次の節で示します。</p>
<section type="division" aria-labelledby="sec15">
<h5 class="h2" id="calibre_link-1876"><span class="sans_futura_std_bold_b_">列と行を操作する</span></h5>
<p class="tni">GoogleスプレッドシートのセルはExcelと同じように操作できます。Pythonの0始まりのリストインデックスとは異なり、Googleスプレッドシートの行と列は1始まりです。最初の行や列のインデックスは1であり、0ではありません。<span class="thesansmonocd_w5regular_">convertAddress()</span>関数を使えば、<span class="thesansmonocd_w5regular_">'A2'</span>のような文字スタイルの座標を<span class="thesansmonocd_w5regular_">(column, row)</span>のようなタプルスタイルの座標に変換できます（逆の変換もできます）。<span class="thesansmonocd_w5regular_">getColumnLetterOf()</span>関数と<span class="thesansmonocd_w5regular_">getColumnNumberOf()</span>関数は、列のアルファベットと数値を変換します。対話型シェルで次のように入力してみてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ezsheets.convertAddress('A2')</b>  # 文字スタイルの座標を変換
(1, 2)
&gt;&gt;&gt; <b class="calibre10">ezsheets.convertAddress(1, 2)</b>  # タプルスタイルの座標を変換
'A2'
&gt;&gt;&gt; <b class="calibre10">ezsheets.getColumnLetterOf(2)</b>
'B'
&gt;&gt;&gt; <b class="calibre10">ezsheets.getColumnNumberOf('B')</b>
2
&gt;&gt;&gt; <b class="calibre10">ezsheets.getColumnLetterOf(999)</b>
'ALK'
&gt;&gt;&gt; <b class="calibre10">ezsheets.getColumnNumberOf('ZZZ')</b>
18278
</code></pre>
<p class="tx">ソースコードに座標を入力するなら<span class="thesansmonocd_w5regular_">'A2'</span>文字スタイルの座標が便利です。しかし座標をループさせて列番号が必要になるなら<span class="thesansmonocd_w5regular_">(column, row)</span>タプルスタイルの座標が便利です。2つのスタイルを変換するのに、<span class="thesansmonocd_w5regular_">convertAddress()</span>関数、<span class="thesansmonocd_w5regular_">getColumnLetterOf()</span>関数、<span class="thesansmonocd_w5regular_">getColumnNumberOf()</span>関数が役立ちます。</p>
</section>
<section type="division" aria-labelledby="sec16">
<h5 class="h2" id="calibre_link-1877"><span class="sans_futura_std_bold_b_">列全体または行全体を読み書きする</span></h5>
<p class="tni">先ほど述べたように、一度に一つのセルに書き込むと時間がかかりすぎます。EZSheetsには、列全体または行全体を読み書きする<span class="thesansmonocd_w5regular_">Sheet</span>メソッドがあります。<span class="thesansmonocd_w5regular_">getColumn()</span>、<span class="thesansmonocd_w5regular_">getRow()</span>、<span class="thesansmonocd_w5regular_">updateColumn()</span>、<span class="thesansmonocd_w5regular_">updateRow()</span>のメソッドが、それぞれ列全体または行全体を読み書きします。これらのメソッドはGoogleスプレッドシートのサーバーにリクエストを送り、スプレッドシートを更新します。よってインターネット接続が必要になります。この節の例では、<span>第14章</span>の<i class="calibre5">produceSales3.xlsx</i>をGoogleスプレッドシートにアップロードして使います。このファイルは本書のオンライン素材からダウンロードできます。最初の8行を表15-1に示します。</p>
<table class="basic-table">
<caption class="calibre12"><p class="tt" id="calibre_link-773"><span class="sans_futura_std_bold_b_"><span class="sans_futura_std_bold_b_">表 15-1：</span></span><span class="sans_futura_std_book_oblique_i_">produceSales3.xlsx</span><span class="sans_futura_std_book_">ファイルの最初の8行</span></p></caption>

<thead class="calibre13">
<tr class="calibre14">
<td class="tch2"></td>
<th class="tch" scope="col"><p class="tch1"><span class="sans_futura_std_bold_b_">A</span></p></th>
<th class="tch" scope="col"><p class="tch1"><span class="sans_futura_std_bold_b_">B</span></p></th>
<th class="tch" scope="col"><p class="tch1"><span class="sans_futura_std_bold_b_">C</span></p></th>
<th class="tch" scope="col"><p class="tch1"><span class="sans_futura_std_bold_b_">D</span></p></th>
</tr>
</thead>
<tbody class="calibre15">
<tr class="calibre16">
<td class="tbf"><p class="tch1"><span class="sans_futura_std_bold_b_">1</span></p></td>
<td class="tbf"><p class="tch1"><span class="sans_futura_std_book_">PRODUCE</span></p></td>
<td class="tbf"><p class="tch1"><span class="sans_futura_std_book_">COST PER POUND</span></p></td>
<td class="tbf"><p class="tch1"><span class="sans_futura_std_book_">POUNDS SOLD</span></p></td>
<td class="tbf"><p class="tch1"><span class="sans_futura_std_book_">TOTAL</span></p></td>
</tr>
<tr class="calibre14">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">2</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Potatoes</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">0.86</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">21.6</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">18.58</span></p></td>
</tr>
<tr class="calibre16">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">3</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Okra</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">2.26</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">38.6</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">87.24</span></p></td>
</tr>
<tr class="calibre14">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">4</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Fava beans</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">2.69</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">32.8</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">88.23</span></p></td>
</tr>
<tr class="calibre16">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">5</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Watermelon</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">0.66</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">27.3</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">18.02</span></p></td>
</tr>
<tr class="calibre14">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">6</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Garlic</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">1.19</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">4.9</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">5.83</span></p></td>
</tr>
<tr class="calibre16">
<td class="tb"><p class="tch1"><span class="sans_futura_std_bold_b_">7</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">Parsnips</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">2.27</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">1.1</span></p></td>
<td class="tb"><p class="tch1"><span class="sans_futura_std_book_">2.5</span></p></td>
</tr>
<tr class="calibre14">
<td class="tbl"><p class="tch1"><span class="sans_futura_std_bold_b_">8</span></p></td>
<td class="tbl"><p class="tch1"><span class="sans_futura_std_book_">Asparagus</span></p></td>
<td class="tbl"><p class="tch1"><span class="sans_futura_std_book_">2.49</span></p></td>
<td class="tbl"><p class="tch1"><span class="sans_futura_std_book_">37.9</span></p></td>
<td class="tbl"><p class="tch1"><span class="sans_futura_std_book_">94.37</span></p></td>
</tr>
</tbody>
</table>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1134" aria-label="370"></span><i class="calibre5">produceSales3.xlsx</i>ファイルを現在の作業ディレクトリに置いて、対話型シェルで以下の内容を実行してこのExcelファイルをアップロードしてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.upload('produceSales3.xlsx')</b>
&gt;&gt;&gt; <b class="calibre10">sheet = ss.sheets[0]</b>
&gt;&gt;&gt; <b class="calibre10">sheet.getRow(1)</b>  # 最初の行は0ではなく1
['PRODUCE', 'COST PER POUND', 'POUNDS SOLD', 'TOTAL', '', '']
&gt;&gt;&gt; <b class="calibre10">sheet.getRow(2)</b>
['Potatoes', '0.86', '21.6', '18.58', '', '']
&gt;&gt;&gt; <b class="calibre10">sheet.getColumn(1)</b>
['PRODUCE', 'Potatoes', 'Okra', 'Fava beans', 'Watermelon', 'Garlic',
<var class="calibre20">--snip--</var>
&gt;&gt;&gt; <b class="calibre10">sheet.getColumn('A')</b>  # getColumn(1)と同じ
['PRODUCE', 'Potatoes', 'Okra', 'Fava beans', 'Watermelon', 'Garlic',
<var class="calibre20">--snip--</var>
&gt;&gt;&gt; <b class="calibre10">sheet.getRow(3)</b>
['Okra', '2.26', '38.6', '87.24', '', '']
&gt;&gt;&gt; <b class="calibre10">sheet.updateRow(3, ['Pumpkin', '11.50', '20', '230'])</b>
&gt;&gt;&gt; <b class="calibre10">sheet.getRow(3)</b>
['Pumpkin', '11.50', '20', '230', '', '']
&gt;&gt;&gt; <b class="calibre10">columnOne = sheet.getColumn(1)</b>
&gt;&gt;&gt; <b class="calibre10">for i, value in enumerate(columnOne):</b>
...     # Pythonのリスト内の文字列を大文字に
...     <b class="calibre10">columnOne[i] = value.upper()</b>
...
&gt;&gt;&gt; <b class="calibre10">sheet.updateColumn(1, columnOne)</b>  # 列全体を1回のリクエストで更新
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">getRow()</span>関数と<span class="thesansmonocd_w5regular_">getColumn()</span>関数は指定した行または列のすべてのセルのデータをリストとして取得します。空白セルはリスト内で空白文字列値になります。<span class="thesansmonocd_w5regular_">getColumn()</span>に列番号とアルファベット文字のどちらを渡しても、指定した列のデータを取得します。先の例では<span class="thesansmonocd_w5regular_">getColumn(1)</span>と<span class="thesansmonocd_w5regular_">getColumn('A')</span>が同じリストを返すことを示しています。</p>
<p class="tx"><span class="thesansmonocd_w5regular_">updateRow()</span>関数と<span class="thesansmonocd_w5regular_">updateColumn()</span>関数は、渡した値のリストで、行または列のデータを上書きします。この例では、3行目は最初okra（オクラ）の情報を含んでいましたが、<span class="thesansmonocd_w5regular_">updateRow()</span>呼び出しによりpumpkins（かぼちゃ）のデータに置き換えました。<span class="thesansmonocd_w5regular_">sheet.getRow(3)</span>をもう一度呼び出すと、3行目の新しい値を確認できます。</p>
<p class="tx">たくさんのセルを更新するときに、セルを一つずつ更新するのは遅いです。列または行をリストとして取得し、リストを更新して、そのリストで列全体または行全体を更新すれば、ずっと速いです。すべての変更をGoogle Cloudのサービスへの一度のリクエストでできるからです。</p>
<p class="tx"><span class="thesansmonocd_w5regular_">getRows()</span>メソッドを呼び出すと、リストのリストが返され、すべての行を一度で取得できます。外側のリストの中に入っている内側のリストはシートの一つの行を表します。このデータ構造中の、農産物の種類、販売ポンド数、総売上の一部の値を変更します。そして、それを<span class="thesansmonocd_w5regular_">updateRows()</span>メソッドに渡します。以下の対話型シェルの内容を実行してください。</p>
<pre class="pre"><code class="calibre9"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1033" aria-label="371"></span>&gt;&gt;&gt; <b class="calibre10">rows = sheet.getRows()</b>  # スプレッドシートのすべての行を取得
&gt;&gt;&gt; <b class="calibre10">rows[0]</b>  # 最初の行の値
['PRODUCE', 'COST PER POUND', 'POUNDS SOLD', 'TOTAL', '', '']
&gt;&gt;&gt; <b class="calibre10">rows[1]</b>
['POTATOES', '0.86', '21.6', '18.58', '', '']
&gt;&gt;&gt; <b class="calibre10">rows[1][0] = 'PUMPKIN'</b>  # 農産物の種類を変更
&gt;&gt;&gt; <b class="calibre10">rows[1]</b>
['PUMPKIN', '0.86', '21.6', '18.58', '', '']
&gt;&gt;&gt; <b class="calibre10">rows[10]</b>
['OKRA', '2.26', '40', '90.4', '', '']
&gt;&gt;&gt; <b class="calibre10">rows[10][2] = '400'</b>  # 販売ポンド数を変更
&gt;&gt;&gt; <b class="calibre10">rows[10][3] = '904'</b>  # 総売上を変更
&gt;&gt;&gt; <b class="calibre10">rows[10]</b>
['OKRA', '2.26', '400', '904', '', '']
&gt;&gt;&gt; <b class="calibre10">sheet.updateRows(rows)</b>  # 変更点についてオンラインのスプレッドシートを更新
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">getRows()</span>から返されたリストのリストの1行目と10行目を修正して、<span class="thesansmonocd_w5regular_">updateRows()</span>にそのリストのリストを渡すことで、シート全体を一回のリクエストで更新しています。</p>
<p class="tx">このGoogleスプレッドシートには最後に空白の列があることに注意してください。アップロードしたシートには6列ありますが、データは4列しかありません。<span class="thesansmonocd_w5regular_">rowCount</span>属性と<span class="thesansmonocd_w5regular_">columnCount</span>属性でシートの行数と列数を読み取れます。これらの属性に値を設定すると、シートのサイズを変えられます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">sheet.rowCount</b>  # シートの行数
23758
&gt;&gt;&gt; <b class="calibre10">sheet.columnCount</b>  # シートの列数
6
&gt;&gt;&gt; <b class="calibre10">sheet.columnCount = 4</b>  # 列数を4に変更
&gt;&gt;&gt; <b class="calibre10">sheet.columnCount</b>  # シートの列数は4
4
</code></pre>
<p class="tx">この指示により<i class="calibre5">produceSales3.xlsx</i>の5列目と6列目を削除します。図15-3にその様子を示しました。</p>
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-1294" aria-label="372"></span>
<figure class="img"><img class="img3" id="calibre_link-774" src="images/000030.jpg" alt="Two versions of a spreadsheet showing produce information. In the first, the last two columns, E and F, are empty. In the second, the E and F columns have been removed." />
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">図 15-3：列数を4に変更する前（上）と後（下）</span></p></figcaption>
</figure>
<p class="tx">Googleのドキュメントによると、Googleスプレッドシートは1000万セルまで収納できます。しかし、データの更新にかかる時間を短くするためにシートを必要なだけの大きさにするのがよいでしょう。</p>
</section>
</section>
<section type="division" aria-labelledby="sec17">
<h4 class="h1" id="calibre_link-1878"><span id="calibre_link-417"></span><span class="sans_futura_std_heavy_oblique_bi_">シートの作成、移動、削除</span></h4>
<p class="tni">Googleスプレッドシートは、<i class="calibre5">Sheet1</i>という名前の一つのシートだけがある状態で始まります。<span class="thesansmonocd_w5regular_">Sheet()</span>メソッドでシートのリストの末尾にシートを追加できます。文字列を渡して新しいシート名を指定することもできます。オプションの第二引数には、新しいシートを作成するインデックスを整数で指定します。対話型シェルで以下の内容を実行して、スプレッドシートを作成して新しいシートを追加してみだくさい。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">ss.title = 'Multiple Sheets'</b>
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1',)
&gt;&gt;&gt; <b class="calibre10">ss.Sheet('Spam')</b>  # シートのリストの末尾に新しいシートを作成
&lt;Sheet sheetId=2032744541, title='Spam', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss.Sheet('Eggs')</b>  # さらに新しいシートを作成
&lt;Sheet sheetId=417452987, title='Eggs', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1', 'Spam', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">ss.Sheet('Bacon', 0)</b>  # シートのリストのインデックス0に新しいシートを作成
&lt;Sheet sheetId=814694991, title='Bacon', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Bacon', 'Sheet1', 'Spam', 'Eggs')
</code></pre>
<p class="tx">この指示では、デフォルトの<i class="calibre5">Sheet1</i>に加えて、<i class="calibre5">Bacon</i>、<i class="calibre5">Spam</i>、<i class="calibre5">Eggs</i>という3つの新しいシートをスプレッドシートに追加しています。スプレッドシートのシートには順序があり、<span class="thesansmonocd_w5regular_">Sheet()</span>の第二引数で追加するシートのインデックスを指定しない限り新しいシートはリストの末尾に追加されます。<i class="calibre5">Bacon</i>という名前のシートをインデックス<span class="thesansmonocd_w5regular_">0</span>に追加したので、<i class="calibre5">Bacon</i>はこのスプレッドシートの最初に来ています。他の3つのシートは一つずつ位置がずれます。この挙動は<span class="thesansmonocd_w5regular_">insert()</span>リストメソッドに似ています。</p>
<p class="tx">図15-4に示すように、新しいシートが画面下部のタブで確認できます。</p>
<figure class="img"><img class="img1" id="calibre_link-775" src="images/000031.jpg" alt="A Google Sheets file called Multiple Sheets with four tabs, Bacon, Sheet1, Spam, and Eggs. Bacon is highlighted, and the spreadsheet is blank." />
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">図  15-4：</span><span class="sans_futura_std_book_">スプレッドシートに</span><span class="sans_futura_std_book_">Spam</span><span class="sans_futura_std_book_oblique_i_">、</span><span class="sans_futura_std_book_">Eggs</span><span class="sans_futura_std_book_oblique_i_">、</span><span class="sans_futura_std_book_">Bacon</span>シートを追加して複数のシートがあるスプレッドシート</p></figcaption>
</figure>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1064" aria-label="374"></span>シートの順序はindex属性からわかり、index属性に新しい値を代入するとシートの順序を変えられます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Bacon', 'Sheet1', 'Spam', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0].index</b>
0
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0].index = 2</b>  # シートのインデックスを0から2に移動
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1', 'Spam', 'Bacon', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">ss.sheets[2].index = 0</b>  # シートのインデックスを2から0に移動
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Bacon', 'Sheet1', 'Spam', 'Eggs')
</code></pre>
<p class="tx"><span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトの<span class="thesansmonocd_w5regular_">delete()</span>メソッドは、スプレッドシートからシートを削除します。シートを残してそのシートのデータを削除したければ、<span class="thesansmonocd_w5regular_">clear()</span>メソッドを呼び出してすべてのセルをクリアして空白のシートにします。以下の式を対話型シェルに入力してみてください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Bacon', 'Sheet1', 'Spam', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0].delete()</b>  # インデックス0の"Bacon"シートを削除
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1', 'Spam', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">ss['Spam'].delete()</b>  # "Spam"シートを削除
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1', 'Eggs')
&gt;&gt;&gt; <b class="calibre10">sheet = ss['Eggs']</b>  # "Eggs"シートを変数に代入
&gt;&gt;&gt; <b class="calibre10">sheet.delete()</b>  # "Eggs"シートを削除
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>
('Sheet1',)
&gt;&gt;&gt; <b class="calibre10">ss.sheets[0].clear()</b>  # "Sheet1"シートのセルをすべてクリア
&gt;&gt;&gt; <b class="calibre10">ss.sheetTitles</b>  # "Sheet1"シートは空白だが存在
('Sheet1',)
</code></pre>
<p class="tx">シートは完全に削除されます。データを回復する方法はありません。<span class="thesansmonocd_w5regular_">copyTo()</span>メソッドで別のスプレッドシートにコピーすれば、バックアップできます。次の節ではコピーについて説明します。</p>
</section>
<section type="division" aria-labelledby="sec18">
<h4 class="h1" id="calibre_link-1879"><span id="calibre_link-418"></span><span class="sans_futura_std_heavy_oblique_bi_">シートのコピー</span></h4>
<p class="tni"><span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトには<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのリストがあります。（前の節で説明したように）このリストの順序を変えればシートの順序を変えられます。このリストを別のスプレッドシートにコピーすることもできます。<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトを別の<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトにコピーするには、<span class="thesansmonocd_w5regular_">copyTo()</span>メソッドを呼び出します。コピー先のスプレッドシートの<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトを引数として渡します。スプレッドシートを2つ作成し、1つ目のスプレッドシートのデータを2つ目のスプレッドシートにコピーします。対話型シェルに以下の内容を入力してください。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss1 = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">ss1.title = 'First Spreadsheet'</b>
&gt;&gt;&gt; <b class="calibre10">ss1.sheets[0].title = 'Spam'</b>  # ss1にSpamという名前のシートを持たせる
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-1152" aria-label="375"></span>&gt;&gt;&gt; <b class="calibre10">ss2 = ezsheets.Spreadsheet()</b>
&gt;&gt;&gt; <b class="calibre10">ss2.title = 'Second Spreadsheet'</b>
&gt;&gt;&gt; <b class="calibre10">ss2.sheets[0].title = 'Eggs'</b>  # ss2にEggsという名前のシートを持たせる
&gt;&gt;&gt; <b class="calibre10">ss1[0]</b>
&lt;Sheet sheetId=0, title='Spam', rowCount=1000, columnCount=26&gt;
&gt;&gt;&gt; <b class="calibre10">ss1[0].updateRow(1, ['Some', 'data', 'in', 'the', 'first', 'row'])</b>
&gt;&gt;&gt; <b class="calibre10">ss1[0].copyTo(ss2)</b>  # ss1の1番目のシートをss2スプレッドシートにコピー
&gt;&gt;&gt; <b class="calibre10">ss2.sheetTitles</b>  # ss2にはss1の1番目のシートのコピーがある
('Eggs', 'Copy of Spam')
</code></pre>
<p class="tx">コピーしたシートは、コピー先のスプレッドシートのシートのリストの末尾に<span class="thesansmonocd_w5regular_">Copy of</span>という接頭辞つきで現れます。新しいスプレッドシートの<span class="thesansmonocd_w5regular_">index</span>属性を変更すればシートの順序を変えられます。</p>
</section>
</section>
<section type="division" aria-labelledby="sec19">
<h3 class="h" id="calibre_link-1880"><span id="calibre_link-419"></span><span class="sans_futura_std_bold_b_">Googleフォーム</span></h3>
<p class="tni">Googleアカウントがあれば、<i class="calibre5"><a href="https://forms.google.com/" class="calibre1">https://<wbr></wbr>forms<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/</a></i>からGoogleフォームを利用できます。Googleフォームでは、調査、イベント登録、フィードバック収集ができ、ユーザーが送信した回答をGoogleスプレッドシートで受け取ります。EZSheetsを使えば、Pythonプログラムでそのスプレッドシートのデータにアクセスできます。</p>
<p class="tx"><span>第19章</span>でPythonプログラムを指定した時間に定期実行するスケジュール方法を説明します。定期的にGoogleフォームの回答スプレッドシートをチェックして、新しい回答がないかを確認するプログラムを書けます。<span>第20章</span>で説明する内容を活用すれば、プログラムに通知をさせて、フォーム提出のリアルタイム通知を受けることができます。</p>
<p class="tx">ここまで見てきたように、Pythonは複数の既存のソフトウェアシステムをつなげて、全体が部分の総和よりも強力になるような自動化プロセスを作成できるので、グルー（糊）言語としてよく知られています。</p>
<p class="ph"><span id="calibre_link-420"></span><span class="sans_futura_std_heavy_b_">プロジェクト11：うそのブロックチェーン暗号資産詐欺</span></p>
<p class="tni">このプロジェクトでは、Googleスプレッドシートをうそのブロックチェーンとして用いて、ボーリングコインの取引を追跡します。ボーリングコインは筆者が考え出した暗号資産詐欺です。（投資家も利用者も、ブロックチェーンが本物のブロックチェーンのデータ構造であるかどうかなんて気にしないでお金を出しているとわかりました。）</p>
<p class="tx"><i class="calibre5"><a href="https://autbor.com/boringcoin" class="calibre1">https://<wbr></wbr>autbor<wbr></wbr>.com<wbr></wbr>/boringcoin</a></i>はボーリングコインブロックチェーンのGoogleスプレッドシートにリダイレクトします。このスプレッドシートには、取引の送信者、取引の受信者、取引量の3列あります。取引量だけ送信者から差し引き受信者に加えます。送信者が<span class="thesansmonocd_w5regular_">'PRE-MINE'</span>であれば、これは何もないところからお金が作り出されたものであり、受信者のアカウントに加えられます。図15-5はこのGoogleスプレッドシートを示しています。</p>
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-942" aria-label="376"></span>
<figure class="img"><img class="img1" id="calibre_link-776" src="images/000032.jpg" alt="A Google Sheets spreadsheet called Boringcoin containing a list of names in columns A and B and a list of values in column C. The first cell in column A has the value PRE-MINE." />
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">図 15-5：Googleスプレッドシートに格納されたボーリングコインのうそのブロックチェーン</span></p></figcaption>
</figure>
<p class="tx">最初の取引は送信者が<span class="thesansmonocd_w5regular_">'PRE-MINE'</span>で受信者が<span class="thesansmonocd_w5regular_">'Al Sweigart'</span>です。取引量はたったの<span class="thesansmonocd_w5regular_">1000000000</span>です。<span class="thesansmonocd_w5regular_">'Al Sweigart'</span>アカウントは<span class="thesansmonocd_w5regular_">19116</span>ボーリングコインを<span class="thesansmonocd_w5regular_">'Miles Bron'</span>に送信し、<span class="thesansmonocd_w5regular_">'Miles Bron'</span>は<span class="thesansmonocd_w5regular_">118</span>ボーリングコインを<span class="thesansmonocd_w5regular_">'not_a_scammer'</span>に送信しました。4番目の取引では<span class="thesansmonocd_w5regular_">16273</span>ボーリングコインを<span class="thesansmonocd_w5regular_">'Al Sweigart'</span>から<span class="thesansmonocd_w5regular_">'some hacker'</span>に送信しました。（私はこの取引を承認しておらず、それ以来<i class="calibre5">python12345</i>を自分のGoogleアカウントのパスワードに使うのをやめました。）</p>
<p class="tx">2つのプログラムを書きます。1つは、すべての取引を精査し、すべてのアカウントとその現在残高の辞書を作成する<i class="calibre5">auditBoringcoin.py</i>プログラムです。もう1つは、Googleスプレッドシートの末尾に新しい取引の行を追加する<i class="calibre5">addBoringcoinTransaction.py</i>プログラムです。このブロックチェーンプログラムはただのお遊びで現実のものではありません（NFTやweb3といった「現実の」ブロックチェーンも空想的なものではありますが）。</p>
<section type="division" aria-labelledby="sec20">
<h4 class="h1" id="calibre_link-1881"><span id="calibre_link-421"></span><span class="sans_futura_std_heavy_oblique_bi_">ステップ1：うそのブロックチェーン監査</span></h4>
<p class="tni">「ブロックチェーン」全体を精査し、すべてのアカウントの現在残高を判定するプログラムを書きます。このデータを保持するのに辞書を使います。キーはアカウント名で値はボーリングコインの保有量です。このプログラムでは暗号資産ネットワークに存在するボーリングコインの総量も表示します。EZSheetsをインポートして辞書を設定するところから始めます。</p>
<pre class="pre"><code class="calibre9">import ezsheets
ss = ezsheets.Spreadsheet('https://autbor.com/boringcoin')
accounts = {}  # キーはアカウント名、値は保有量
</code></pre>
<p class="tx">次に、スプレッドシートの各行を反復処理します。送信者と受信者と取引量を把握します。Googleスプレッドシートはデータを常に文字列として返しますから、<span class="thesansmonocd_w5regular_">amount</span>の値で計算を行うために整数値に変換する必要があります。</p>
<pre class="pre"><code class="calibre9"># 各行は取引であり、一行ずつ反復処理する
for row in ss.sheets[0].getRows():
    sender, recipient, amount = row[0], row[1], int(row[2])
</code></pre>
<p class="tx">送信者が<span class="thesansmonocd_w5regular_">'PRE-MINE'</span>という特別なアカウントであれば、これは無限のお金の源です。暗号資産詐欺のいいところは事前に採掘されたコインを使えることで、ボーリングコインも例に漏れません。取引量を<span class="thesansmonocd_w5regular_">accounts</span>の受信者のアカウントに追加します。辞書に受信者が存在しなければ、<span class="thesansmonocd_w5regular_">setdefault()</span>メソッドでそのアカウントの保有量として<span class="thesansmonocd_w5regular_">0</span>という値を設定します。</p>
<pre class="pre"><code class="calibre9">    if sender == 'PRE-MINE':
        # 送信者'PRE-MINE'は何もないところからお金を作り出す
        accounts.setdefault(recipient, 0)
        accounts[recipient] += amount
</code></pre>
<p class="tx">それ以外の場合は、その取引量を、送信者のアカウントから差し引き、受信者のアカウントに追加します。</p>
<pre class="pre"><code class="calibre9">    else:
        # 送信者から受信者に資金移動
        accounts.setdefault(sender, 0)
        accounts.setdefault(recipient, 0)
        accounts[sender] -= amount
        accounts[recipient] += amount
</code></pre>
<p class="tx">ループが終われば、辞書accountsを表示すれば現在残高がわかります。</p>
<pre class="pre"><code class="calibre9">print(accounts)</code></pre>
<p class="tx">この監査の一部として、この辞書の全員の残高を足し合わせてネットワーク全体におけるボーリングコインの総量を計算します。変数<span class="thesansmonocd_w5regular_">total</span>を<span class="thesansmonocd_w5regular_">0</span>で始めて、<span class="thesansmonocd_w5regular_">for</span>ループで辞書<span class="thesansmonocd_w5regular_">accounts</span>のキーと値のペアを反復処理します。すべての値を<span class="thesansmonocd_w5regular_">total</span>に足し合わせてから、ボーリングコインの総量を表示します。</p>
<pre class="pre"><code class="calibre9">total = 0
for amount in accounts.values():
    total += amount
print('Total Boringcoins:', total)
</code></pre>
<p class="tx">このプログラムを実行すると、出力は次のようになります。</p>
<pre class="pre"><code class="calibre9">{'Al Sweigart': 999058553, 'Miles Bron': 38283, 'not_a_scammer': 48441,
'some hacker': 44429, 'Tech Bro': 53424, 'Claire Debella': 54443,
'Credulous Journalist': 50408, 'Birdie Jay': 36832, 'Carol': 82867, 'Mark Z.':
 68650, 'Bob': 37920, 'Andi Brand': 57218, 'Eve': 88296, 'Al Sweigart sock
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-888" aria-label="378"></span>#27': 78080, 'Tax evader': 40937, 'Duke Cody': 17544, 'Lionel Toussaint':
54650, 'some scammer': 2694, 'Alice': 44503, 'David': 41828}
Total Boringcoins: 1000000000
</code></pre>
<p class="tx">総量は<span class="thesansmonocd_w5regular_">1000000000</span>で、事前採掘されたボーリングコインと一致します。</p>
</section>
<section type="division" aria-labelledby="sec21">
<h4 class="h1" id="calibre_link-1882"><span id="calibre_link-422"></span><span class="sans_futura_std_heavy_oblique_bi_">ステップ2：取引の実行</span></h4>
<p class="tni">次のプログラムは、新たな取引を追加するためにブロックチェーンGoogleスプレッドシートに行を追加する、<i class="calibre5">addBoringcoinTransaction.py</i>です。<span class="thesansmonocd_w5regular_">sys.argv</span>から、送信者、受信者、取引量という、コマンドライン引数を3つ読み取ります。例えば、ターミナルで次のように実行します。</p>
<pre class="pre"><code class="calibre9">python addBoringcoinTransaction.py "Al Sweigart" Eve 2000</code></pre>
<p class="tx">このプログラムはGoogleスプレッドシートにアクセスして、最終行に空行を追加してから、<span class="thesansmonocd_w5regular_">'Al Sweigart'</span>、<span class="thesansmonocd_w5regular_">'Eve'</span>、<span class="thesansmonocd_w5regular_">'2000'</span>という値を埋めます。ターミナルではスペースを含むコマンドライン引数は、<span class="thesansmonocd_w5regular_">"Al Sweigart"</span>のようにダブルクォートで囲まなければなりません。そうしないと、ターミナルはこれらを2つの別の引数であると解釈してしまいます。</p>
<p class="tx"><i class="calibre5">addBoringcoinTransactions.py</i>はまずコマンドライン引数をチェックし、コマンドライン引数に基づいて送信者、受信者、取引量の変数を代入します。</p>
<pre class="pre"><code class="calibre9">import sys, ezsheets

if len(sys.argv) &lt; 4:
    print('Usage: python addBoringcoinTransaction.py sender recipient amount')
    sys.exit()

# コマンドライン引数から取引情報を取得
sender, recipient, amount = sys.argv[1:]
</code></pre>
<p class="tx">スプレッドシートには文字列として書き込みますから、<span class="thesansmonocd_w5regular_">amount</span>を文字列から整数に変換する必要はありません。</p>
<p class="tx">次に、EZSheetsが、うそのブロックチェーンを記録したGoogleスプレッドシートに接続して、インデックス<span class="thesansmonocd_w5regular_">0</span>の最初のシートを選択します。読者のみなさんはボーリングコインGoogleスプレッドシートの編集権限がありませんから、Googleアカウントにログインした状態でウェブブラウザでURLを開いて、<b class="calibre10">ファイル</b><span class="listbullet_menuarrow"></span><b class="calibre10">コピーを作成</b>で自分のGoogleアカウントにコピーしてください。それから、<span class="thesansmonocd_w5regular_">'https://autbor.com/boringcoin'</span>を、ブラウザのアドレスバーに表示されている自分のGoogleスプレッドシートのURLに置き換えてください。</p>
<pre class="pre"><code class="calibre9"># URLを自分のGoogleスプレッドシートのURLに変更
# そうしないと"The caller does not have permission"エラーが発生
ss = ezsheets.Spreadsheet('<var class="calibre20">https://autbor.com/boringcoin</var>')
sheet = ss.sheets[0]
</code></pre>
<p class="tx"><span role="doc-pagebreak" type="pagebreak" id="calibre_link-1277" aria-label="379"></span>最後に、シートの行数を取得して、それを1増やし、その行を送信者、受信者、取引量のデータで埋めます。</p>
<pre class="pre"><code class="calibre9"># シートに新しい取引の1行追加
sheet.rowCount += 1

sheet[1, sheet.rowCount] = sender
sheet[2, sheet.rowCount] = recipient
sheet[3, sheet.rowCount] = amount
</code></pre>
<p class="tx">ターミナルから<span class="thesansmonocd_w5regular_">python addBoringcoinTransaction.py "Al Sweigart" Eve 2000</span>を実行すると、Googleスプレッドシートの最終行に<i class="calibre5">Al Sweigart</i>、<i class="calibre5">Eve</i>、<i class="calibre5">2000</i>の新しい行が追加されます。<i class="calibre5">auditBoringcoin.py</i>プログラムをもう一度実行すると、暗号資産ネットワーク内の最新の全員のアカウントの残高がわかります。</p>
<p class="tx">このGoogleスプレッドシートでのブロックチェーンデータ構造は無責任なものです。エラー処理をしていませんから、大惨事が起こるでしょう。これは大部分の市場化されているブロックチェーン製品も同じようなものです。ネズミ講が破綻する前にボーリングコインを購入するこの機会を見逃さずご連絡ください。</p>
</section>
</section>
<section type="division" aria-labelledby="sec22">
<h3 class="h" id="calibre_link-1883"><span id="calibre_link-423"></span><span class="sans_futura_std_bold_b_">Googleスプレッドシートのサービス割り当て</span></h3>
<p class="tni">Googleスプレッドシートはオンライン上にありますから、簡単にシートを複数人で共有し、同時にアクセスできます。しかし、シートの読み取りと更新が、ハードドライブに保存したExcelファイルと比べると遅いです。さらに、Googleスプレッドシートには、実行できる読み書き操作の回数に制限があります。</p>
<p class="tx">Googleの開発者ガイドラインによると、1日に新しく作成できるスプレッドシートは250までで、無料のGoogleアカウントでは1分あたり数百リクエストまでしかできません。Googleの使用制限は<i class="calibre5"><a href="https://developers.google.com/sheets/api/limits" class="calibre1">https://<wbr></wbr>developers<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/sheets<wbr></wbr>/api<wbr></wbr>/limits</a></i>で確認できます。このサービス割り当てを超過すると<span class="thesansmonocd_w5regular_">googleapiclient.errors.HttpError</span> “Quota exceeded for quota group”が送出されます。EZSheetsは自動的にこの例外を捕捉して、リクエストを再送します。こうなると、データを読み書きする関数呼び出しは数秒（あるいは数分）かかります。リクエストが失敗し続けたら（別のスクリプトが同じ認証情報を使ってリクエストしている場合に起こり得ます）、EZSheetsはこの例外を再送出します。</p>
<p class="tx">つまり、EZSheetsのメソッド呼び出しは数秒かかる可能性があるということです。API使用量を確認してサービス割り当てを増やしたければ、<i class="calibre5"><a href="https://console.developers.google.com/iam-admin/quotas" class="calibre1">https://<wbr></wbr>console<wbr></wbr>.developers<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/iam<wbr></wbr>-admin<wbr></wbr>/quotas</a></i>のIAM と管理/割り当てページで使用量を増やす課金について調べてください。自分で<span class="thesansmonocd_w5regular_">HttpError</span>例外を処理したいということでしたら、<span class="thesansmonocd_w5regular_">ezsheets.IGNORE_QUOTA</span>を<span class="thesansmonocd_w5regular_">True</span>に設定してください。そうするとEZSheetsのメソッドは、これらの例外を送出します。</p>
</section>
<section type="conclusion" role="doc-conclusion" aria-labelledby="sec23">
<span role="doc-pagebreak" type="pagebreak" id="calibre_link-1123" aria-label="380"></span>
<h3 class="h" id="calibre_link-1884"><span id="calibre_link-424"></span><span class="sans_futura_std_bold_b_">まとめ</span></h3>
<p class="tni">Googleスプレッドシートは、ブラウザで実行する人気のあるオンラインのスプレッドシートアプリケーションです。EZSheetsサードパーティパッケージを使うと、スプレッドシートのダウンロード、作成、読み取り、変更ができます。EZSheetsはスプレッドシートを<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトとして表し、そこには<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトのリストが含まれます。各シートにはデータの列と行があり、いくつかの方法で読み取りと更新ができます。</p>
<p class="tx">Googleスプレッドシートはデータの共有と共同編集が簡単にできますが、遅いという欠点があります。ウェブリクエストを通じてスプレッドシートの更新をしなければならず、実行に数秒かかります。とはいえ、たいていの場合、この遅さはPythonスクリプトでEZSheetsを使う際に問題とはならないでしょう。Googleスプレッドシートには変更を行う頻度の制限もあります。</p>
<p class="tx">EZSheetsの機能の完全なドキュメントは、<i class="calibre5"><a href="https://ezsheets.readthedocs.io/" class="calibre1">https://<wbr></wbr>ezsheets<wbr></wbr>.readthedocs<wbr></wbr>.io<wbr></wbr>/</a></i>にあります。</p>
</section>
<section type="division" aria-labelledby="sec24">
<h3 class="h" id="calibre_link-1885"><span id="calibre_link-425"></span><span class="sans_futura_std_bold_b_">練習問題</span></h3>
<p class="listnumber">  1. EZSheetsがGoogleスプレッドシートにアクセスするのに必要な3つのファイルは何ですか？</p>
<p class="listnumber">  2. EZSheetsにある2種類のオブジェクトは何ですか？</p>
<p class="listnumber">  3. GoogleスプレッドシートからExcelファイルを作成するにはどのようにしますか？</p>
<p class="listnumber">  4. ExcelファイルからGoogleスプレッドシートを作成するにはどのようにしますか？</p>
<p class="listnumber">  5. 変数<span class="thesansmonocd_w5regular_">ss</span>に<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトが格納されているとします。<i class="calibre5">Students</i>という名前のシートのB2セルからデータを読み取るコードを書いてください。</p>
<p class="listnumber">  6. 列番号999を表すアルファベットの文字はどのようにすればわかりますか？</p>
<p class="listnumber">  7. シートの行数と列数はどのようにすればわかりますか？</p>
<p class="listnumber">  8. スプレッドシートはどのように削除しますか？　完全に削除されますか？</p>
<p class="listnumber">  9. 新しい<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトを作成する関数と、新しい<span class="thesansmonocd_w5regular_">Sheet</span>オブジェクトを作成する関数を、それぞれ挙げてください。</p>
<p class="listnumber">10. EZSheetsで頻繁に読み書きのリクエストを行いGoogleアカウントのサービス割り当てを超過すると、どうなりますか？</p>
</section>
<section type="division" aria-labelledby="sec25">
<h3 class="h" id="calibre_link-1886"><span id="calibre_link-426"></span><span class="sans_futura_std_bold_b_">練習プログラム</span></h3>
<p class="tni">以下の練習プログラムを書いてください。</p>
<section type="division" aria-labelledby="sec26">
<h4 class="h1" id="calibre_link-1887"><span id="calibre_link-427"></span><span class="sans_futura_std_heavy_oblique_bi_">Googleフォームのデータダウンロード</span></h4>
<p class="tni">先に触れたように、Googleフォームを使うと、人々から情報を簡単に集められるシンプルなオンラインフォームを作成できます。フォームに入力された情報はGoogleスプレッドシートに蓄積されます。このプロジェクトでは、ユーザーが入力したフォームの情報を自動的にダウンロードするプログラムを書きます。<i class="calibre5"><a href="https://docs.google.com/forms/" class="calibre1">https://<wbr></wbr>docs<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/forms<wbr></wbr>/</a></i>で新しい空白のフォームを開始して、ユーザーに名前とメールアドレスの入力を求めるフィールドを追加してから、新しいフォームの右上にある<b class="calibre10">「公開」</b>ボタンをクリックします。このフォームで回答例をいくつか入力して準備します。</p>
<p class="tx">フォームの<i class="calibre5">回答</i>タブで、<b class="calibre10">「スプレッドシートにリンク」</b>ボタンをクリックして、ユーザーが送信した回答を蓄積するGoogleスプレッドシートを作成します。回答例がスプレッドシートの最初の行に表示されているはずです。EZSheetsを使ってこのスプレッドシートのメールアドレスのリストを収集するPythonのスクリプトを書いてください。</p>
</section>
<section type="division" aria-labelledby="sec27">
<h4 class="h1" id="calibre_link-1888"><span id="calibre_link-428"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートを別の形式に変換する</span></h4>
<p class="tni">Googleスプレッドシートでは、スプレッドシートを別の形式に変換できます。アップロードするファイルを<span class="thesansmonocd_w5regular_">upload()</span>に渡すスクリプトを書いてください。Googleスプレッドシートにアップロードされたら、<span class="thesansmonocd_w5regular_">downloadAsExcel()</span>や<span class="thesansmonocd_w5regular_">downloadAsODS()</span>などの関数を使って別の形式でそのスプレッドシートのコピーをダウンロードしてください。</p>
</section>
<section type="division" aria-labelledby="sec28">
<h4 class="h1" id="calibre_link-1889"><span id="calibre_link-429"></span><span class="sans_futura_std_heavy_oblique_bi_">スプレッドシートの誤りを発見する</span></h4>
<p class="tni">丸一日かけて豆を数える仕事をして、豆の合計をスプレッドシートにまとめてGoogleスプレッドシートにアップロードしました。このスプレッドシートは誰でも閲覧可能です（編集はできません）。このスプレッドシートは以下のコードで取得できます。</p>
<pre class="pre"><code class="calibre9">&gt;&gt;&gt; <b class="calibre10">import ezsheets</b>
&gt;&gt;&gt; <b class="calibre10">ss = ezsheets.Spreadsheet('1jDZEdvSIh4TmZxccyy0ZXrH-ELlrwq8_YYiZrEOB4jg')</b>
</code></pre>
<p class="tx"><i class="calibre5"><a href="https://docs.google.com/spreadsheets/d/1jDZEdvSIh4TmZxccyy0ZXrH-ELlrwq8_YYiZrEOB4jg" class="calibre1">https://<wbr></wbr>docs<wbr></wbr>.google<wbr></wbr>.com<wbr></wbr>/spreadsheets<wbr></wbr>/d<wbr></wbr>/1jDZEdvSIh4TmZxccyy0ZXrH<wbr></wbr>-ELlrwq8<wbr></wbr>_YYiZrEOB4jg</a></i>でこのスプレッドシートをブラウザでご覧ください。シートの列は、<i class="calibre5">BEANS PER JAR</i>、<i class="calibre5">JARS</i>、<i class="calibre5">TOTAL BEANS</i>です。<i class="calibre5">TOTAL BEANS</i>列は、<i class="calibre5">BEANS PER JAR</i>と<i class="calibre5">JARS</i>の数値の積です。しかし、このシートの15,000行の中に一つだけ誤りがあります。手動で確認するには行数が多すぎます。合計の誤りをチェックするスクリプトを書いてください。</p>
<p class="tx">ヒントとして、<span class="sans_thesansmonocd_w5regular_italic_">ss</span><span class="thesansmonocd_w5regular_">.sheets[0].getRow(</span><span class="sans_thesansmonocd_w5regular_italic_">rowNum</span><span class="thesansmonocd_w5regular_">)</span>で行内の各セルにアクセスします。<span class="sans_thesansmonocd_w5regular_italic_">ss</span>は<span class="thesansmonocd_w5regular_">Spreadsheet</span>オブジェクトで、<span class="sans_thesansmonocd_w5regular_italic_">rowNum</span>は行番号です。Googleスプレッドシートの行番号は0ではなく1から始まることに注意してください。セルの値は文字列ですから、計算をする前に整数に変換する必要があります。<span class="thesansmonocd_w5regular_">int(</span><span class="sans_thesansmonocd_w5regular_italic_">ss</span><span class="thesansmonocd_w5regular_">.sheets[0].getRow(2)[0]) * int(</span><span class="sans_thesansmonocd_w5regular_italic_">ss</span><span class="thesansmonocd_w5regular_">.sheets[0].getRow(2)[1])</span> <span class="thesansmonocd_w5regular_">==</span> <span class="thesansmonocd_w5regular_">int(</span><span class="sans_thesansmonocd_w5regular_italic_">ss</span><span class="thesansmonocd_w5regular_">.sheets[0].getRow(2)[2])</span>という式は2行目の合計が正しければ<span class="thesansmonocd_w5regular_">True</span>を返します。このコードをループ内で用いて合計が誤っている行を特定してください。</p>
</section>
</section>
</section>
</div>

</div>



</body></html>